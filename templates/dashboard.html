{% extends "base.html" %}
{% block content %}

<style>
    .stats-grid{
        display:grid;
        grid-template-columns:repeat(5,1fr);
        gap:14px;
        margin-bottom:20px;
    }
    .stat-box{
        background:#0f172a;
        border:1px solid #1e293b;
        padding:18px;
        border-radius:12px;
        box-shadow:0 0 0 1px #1e293b inset;
    }
    .stat-title{
        font-size:13px;
        opacity:0.7;
    }
    .stat-value{
        font-size:26px;
        font-weight:bold;
        margin-top:4px;
    }
    /* Kichik grafik kartalari */
    .chart-box{
        background:#0f172a;
        border-radius:14px;
        border:1px solid #1e293b;
        padding:14px;
        height:200px;
        cursor:pointer;
        transition:0.25s;
    }
    .chart-box:hover{
        border-color:#3b82f6;
        transform:scale(1.02);
    }
    .charts-grid{
        display:grid;
        grid-template-columns:repeat(3,1fr);
        gap:16px;
    }

    /* --- MODAL --- */
    #chartModal{
        position:fixed;
        left:0; top:0;
        width:100%; height:100%;
        background:rgba(0,0,0,0.6);
        display:none;
        align-items:center;
        justify-content:center;
        z-index:99999;
        backdrop-filter:blur(4px);
    }
    #chartModal .modal-content{
        background:#fff;
        width:80%;
        max-width:900px;
        padding:20px;
        border-radius:16px;
        position:relative;
    }
    #chartModal button{
        position:absolute;
        top:10px;
        right:10px;
        background:#f3f4f6;
        border:none;
        padding:6px 10px;
        border-radius:8px;
        cursor:pointer;
        font-size:16px;
    }
</style>




<h2>AI Imperiya – Rahbar paneli</h2>

<div class="stats-grid">

    <div class="stat-box">
        <div class="stat-title">Umumiy topshiriqlar</div>
        <div class="stat-value">{{ total_tasks }}</div>
    </div>

    <div class="stat-box">
        <div class="stat-title">Jarayondagi topshiriqlar</div>
        <div class="stat-value">{{ in_progress }}</div>
    </div>

    <div class="stat-box">
        <div class="stat-title">Bajarilgan topshiriqlar</div>
        <div class="stat-value">{{ completed_tasks }}</div>
    </div>

    <div class="stat-box">
        <div class="stat-title">Elektr iste’moli</div>
        <div class="stat-value">{{ total_energy }} kWh</div>
    </div>

    <div class="stat-box">
        <div class="stat-title">So‘nggi solar energiya</div>
        <div class="stat-value">{{ last_solar or 0 }} kWh</div>
    </div>

</div>


<h3>Topshiriqlar holati</h3>

<div class="charts-grid">

    <div class="chart-box" onclick="openChartModal('ijro')">
        <canvas id="ijroChart"></canvas>
    </div>

    <div class="chart-box" onclick="openChartModal('oylik')">
        <canvas id="monthlyChart"></canvas>
    </div>

    <div class="chart-box" onclick="openChartModal('solar')">
        <canvas id="solarChart"></canvas>
    </div>

</div>


<!-- ====================== MODAL ======================= -->
<div id="chartModal">
    <div class="modal-content">
        <button onclick="closeModal()">✕</button>
        <canvas id="modalChart" style="height:420px;"></canvas>
    </div>
</div>
<!-- ==================================================== -->



<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

    /* ============ IJRO DONUT ============= */
    new Chart(document.getElementById("ijroChart"), {
        type:'doughnut',
        data:{
            labels:["Bajarilgan","Jarayonda","Bekor qilingan"],
            datasets:[{
                data:[
                    {{ completed_tasks }},
                    {{ in_progress }},
                    {{ rejected_tasks|default(0) }}
                ],
                backgroundColor:["#22c55e","#fbbf24","#ef4444"],
                borderWidth:1
            }]
        },
        options:{responsive:true}
    });


    /* ============ OYLIK DINAMIKA ============= */
    new Chart(document.getElementById("monthlyChart"), {
        type:'line',
        data:{
            labels: {{ monthly_labels|safe }},
            datasets:[{
                label:"Oylik ijro",
                data: {{ monthly_values|safe }},
                borderColor:"#3b82f6",
                backgroundColor:"rgba(59,130,246,0.18)",
                borderWidth:2,
                tension:0.4,
                fill:true
            }]
        },
        options:{responsive:true}
    });


    /* ============ SOLAR LINE ============= */
    new Chart(document.getElementById("solarChart"), {
        type:'line',
        data:{
            labels: {{ solar_labels|safe }},
            datasets:[{
                label:"Solar (kWh)",
                data: {{ solar_values|safe }},
                borderColor:"#22c55e",
                backgroundColor:"rgba(34,197,94,0.18)",
                borderWidth:2,
                tension:0.4,
                fill:true
            }]
        },
        options:{responsive:true}
    });


    /* =================== MODAL LOGIC =================== */

    let modalChartInstance = null;

    function openChartModal(type){
        document.getElementById("chartModal").style.display = "flex";

        const ctx = document.getElementById("modalChart").getContext("2d");
        if(modalChartInstance){ modalChartInstance.destroy(); }

        if(type === "solar"){
            modalChartInstance = new Chart(ctx,{
                type:'line',
                data:{
                    labels: {{ solar_labels|safe }},
                    datasets:[{
                        label:"Solar energiya (kWh)",
                        data: {{ solar_values|safe }},
                        borderColor:"#22c55e",
                        backgroundColor:"rgba(34,197,94,0.2)",
                        fill:true,
                        tension:0.4
                    }]
                }
            });
        }

        if(type === "ijro"){
            modalChartInstance = new Chart(ctx,{
                type:'doughnut',
                data:{
                    labels:["Bajarilgan","Jarayonda","Bekor qilingan"],
                    datasets:[{
                        data:[
                            {{ completed_tasks }},
                            {{ in_progress }},
                            {{ rejected_tasks|default(0) }}
                        ],
                        backgroundColor:["#22c55e","#fbbf24","#ef4444"]
                    }]
                }
            });
        }

        if(type === "oylik"){
            modalChartInstance = new Chart(ctx,{
                type:'line',
                data:{
                    labels: {{ monthly_labels|safe }},
                    datasets:[{
                        label:"Oylik ijro dinamikasi",
                        data: {{ monthly_values|safe }},
                        borderColor:"#3b82f6",
                        backgroundColor:"rgba(59,130,246,0.2)",
                        fill:true,
                        tension:0.4
                    }]
                }
            });
        }
    }

    function closeModal(){
        document.getElementById("chartModal").style.display = "none";
    }

</script>

{% endblock %}
